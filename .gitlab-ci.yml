stages: # List of stages for jobs, and their order of execution
  - build-backend
  - build-frontend
  # - test
  # - quality
  - publish-backend
  - publish-frontend
  - deploy-backend
  - deploy-frontend

build-backend:
  stage: build-backend
  image: maven:latest
  script:
    - cd ridesync_backend
    - mvn clean package

build-frontend:
  stage: build-frontend
  image: maven:latest
  script:
    - cd ridesync_backend
    - mvn clean package

publish-backend:
  image: docker:latest
  stage: publish-backend
  tags:
    - test-runner
  # checking tags
  variables:
    # these values may need to be different if using TLS, k8s, etc.

    # You can alternatively set defaults in your runner config
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  services:
    - docker:dind

  script:
    - pwd
    - echo $SERVER_IP
    - docker --version
    - docker login -u meer2838 -p KSP135246@m docker.io
    - cd ridesync_backend
    - docker build -t docker.io/meer2838/cicdtest:midbackend .
    - docker push docker.io/meer2838/cicdtest:midbackend
  only:
    - CICD_Test

publish-frontend:
  image: docker:latest
  stage: publish-frontend
  tags:
    - test-runner
  # checking tags
  variables:
    # these values may need to be different if using TLS, k8s, etc.

    # You can alternatively set defaults in your runner config
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  services:
    - docker:dind

  script:
    - pwd
    - echo $SERVER_IP
    - docker --version
    - docker login -u meer2838 -p KSP135246@m docker.io
    - cd ridesync_frontend
    - docker build -t docker.io/meer2838/cicdtest:midfrontend .
    - docker push docker.io/meer2838/cicdtest:midfrontend
  only:
    - CICD_Test

deploy-backend:
  image: alpine:latest
  stage: deploy-backend
  tags:
    - test-runner
  before_script:
    - apk update && apk add openssh-client
    - eval $(ssh-agent -s)
    - chmod 600 $ID_RSA
    - ssh-add $ID_RSA
  script:
    - chmod og= $ID_RSA
    - apk update && apk add openssh-client
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PWD docker.io"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker pull docker.io/meer2838/cicdtest:midbackend"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker container rm -f my-backend-app || true"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker run -d -p 8073:8073 --name my-backend-app docker.io/meer2838/cicdtest:midbackend"
  # environment:
  #   name: production
  #   url: http://172.17.1.211:8073
  only:
    - CICD_Test

deploy-frontend:
  image: alpine:latest
  stage: deploy-frontend
  tags:
    - test-runner
  before_script:
    - apk update && apk add openssh-client
    - eval $(ssh-agent -s)
    - chmod 600 $ID_RSA
    - ssh-add $ID_RSA
  script:
    - chmod og= $ID_RSA
    - apk update && apk add openssh-client
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PWD docker.io"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker pull docker.io/meer2838/cicdtest:midfrontend"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker container rm -f my-frontend-app || true"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker run -d -p 8073:8073 --name my-frontend-app docker.io/meer2838/cicdtest:midfrontend"
  # environment:
  #   name: production
  #   url: http://172.17.1.211:8073
  only:
    - CICD_Test
